import asyncio
from ollama import AsyncClient
from typing import Dict

# словарь для перевода кодов нарушений в описания
violation_codes: Dict[str, str] = {
    'S1': 'Преступления с применением насилия',
    'S2': 'Преступления без применения насилия',
    'S3': 'Преступления, связанные с сексом',
    'S4': 'Эксплуатация детей в сексуальных целях',
    'S5': 'Клевета',
    'S6': 'Специализированная консультация',
    'S7': 'Конфиденциальность',
    'S8': 'Интеллектуальная собственность',
    'S9': 'Неразборчивое использование оружия',
    'S10': 'Возбуждение ненависти',
    'S11': 'Самоубийство и самоповреждение',
    'S12': 'Сексуальный контент',
    'S13': 'Выборы'
}

HISTORICAL_PROMPT = """
Ты — высококвалифицированный историк и рассказчик с глубокими знаниями в области мировой истории. Твоя задача — подробно и понятно рассказывать об исторических событиях, эпохах, важных личностях и местах, где эти события происходили. Твои ответы должны отвечать следующим требованиям:

1. Точность и достоверность. Используй только проверенные исторические факты и данные, избегай домыслов.
2. Полнота и структура. Сначала кратко вводи в тему, обозначай ключевые моменты, затем подробно раскрывай детали — даты, причины, следствия, ключевых участников и места.
3. Исторический контекст. Объясняй значимость события для своего времени и последствия.
4. Описание мест. Если речь о месте, опиши географию, историческую значимость и современное состояние.
5. Доступность и интерес. Пиши простым, понятным языком для широкой аудитории.
6. Объективность. Не выражай личных мнений или предположений.
7. Если вопрос общий или неясный, проси уточнить тему, период или регион.
8. Добавляй интересные факты и культурные аспекты, чтобы лучше понять эпоху.
9. Поддерживай структуру и избегай длинных списков.
"""

async def check_safety(prompt: str) -> str:
    """
    асинхронно проверяет запрос через Llama Guard 3 на безопасность.

    :param prompt: входной запрос для проверки
    :return: результат проверки безопасности
    """
    response = await AsyncClient().generate(model='llama-guard3:8b', prompt=prompt, system=HISTORICAL_PROMPT)
    return response

async def generate_answer(prompt: str) -> str:
    """
    асинхронно генерирует ответ на запрос с проверкой безопасности.

    :param prompt: входной запрос для ответа
    :return: ответ или сообщение об отклонении
    """
    safety_status = await check_safety(prompt)
    safety_status = safety_status['response']

    if safety_status == 'safe':
        response = await AsyncClient().generate(model='llama3', prompt=prompt)
        return response
    
    lines = safety_status.split('\n')
    if 'unsafe' in lines[0]:
        code = lines[1].strip() if len(lines) > 1 else 'Unknown'
        reason = violation_codes.get(code, 'Неизвестное нарушение')
        return f"⚠️ Запрос отклонён. Причина: {reason} ({code})"
    return f"⚠️ Запрос отклонён. Причина: {safety_status}"

async def main():
    response = await generate_answer('причины второй мировой войны')
    response = response['response']
    print(response)

async def test():
    safety_status = await check_safety('причины второй мировой войны')
    safety_status = safety_status['response']
    print(safety_status)

asyncio.run(main())
